---
title: "Statistics Project"
output: html_notebook
---

This is the Analysis of buyers and sellers of the Etheruem coins Tronix (TRX), OmiseGO (OMG) and YoCoin (YOC). We will be looking at transaction data for these markets and trying to make assumptions about future data.

Load the libraries and set the working directory.

```{r}
library(plyr)
library(readr)
library(ggplot2)
library(dplyr)
library(fitdistrplus)
library(car)

setwd('C:/Users/Adharsh/Documents/2019_Spring/Statistics/R Project')
```

This section is loading each tokens historical data into separate data frames. After loading the dataframes, we plot the opening price against the date. A part of the preprocessing was to adjust the date format that was provided. 

```{r}
yocoin_price_df = read.table("yocoin",
                 col.names = c('Date',	'Open',	'High',	'Low',	'Close',	'Volume',	'MarketCap'),
                 skip = 1,
                 header = FALSE)

tron_price_df = read.table("tron",
                          col.names = c('Date',	'Open',	'High',	'Low',	'Close',	'Volume',	'MarketCap'),
                          skip = 1,
                          header = FALSE)

omg_price_df = read.table("OMISEGO",
                 col.names = c('Date',	'Open',	'High',	'Low',	'Close',	'Volume',	'MarketCap'),
                 skip = 1,
                 header = FALSE)

print("Number of duplicates: ", anyDuplicated(yocoin_price_df))

print("Number of duplicates: ", anyDuplicated(tron_price_df))

print("Number of duplicates: ", anyDuplicated(omg_price_df))


yocoin_price_df$Date = as.Date(yocoin_price_df$Date,format='%m/%d/%Y')

tron_price_df$Date = as.Date(tron_price_df$Date,format='%m/%d/%Y')

omg_price_df$Date = as.Date(omg_price_df$Date,format='%m/%d/%Y')

yocoin_plot <- ggplot(aes(x=Date, y=Open), data = yocoin_price_df) + geom_point(color="darkblue")

yocoin_plot + ggtitle("YOC Historical Data") +
  xlab("Date") + ylab("Opening Price")

tron_plot <- ggplot(aes(x=Date, y=Open), data = tron_price_df) + geom_point(color="darkred")

tron_plot + ggtitle("TRX Historical Data") +
  xlab("Date") + ylab("Opening Price")

omg_plot <- ggplot(aes(x=Date, y=Open), data = omg_price_df) + geom_point(color="green")

omg_plot + ggtitle("OMG Historical Data") +
  xlab("Date") + ylab("Opening Price")
```

Here we load the recent transaction data for each of coins. We only need to specify the column names for the yo coin file because the file format did not include column names.

```{r}
yocoin_edge_df <- read_delim('yo.txt', delim = " ", col_names = F)

names(yocoin_edge_df) <- c('fromID', 'toID', 'unixTime', 'tokenAmount')

tron_edge_df <- read.csv(file = "tronixTransactions.csv", header = T)

omg_edge_df <- read.csv(file = "omgTransactions.csv", header = T)
```


This step is a small portion of processing where we find any transactions where the quantity exceeds the circulating supply.

From these calculations, only YOC had records that needed to be removed.
```{r}
yocoin_decimals = 10^16 
yocoin_supply = 369659255

yocoin_edge_df_filtered = yocoin_edge_df %>% filter(tokenAmount < yocoin_decimals * yocoin_supply)
cat("Num Rows before Filtering: ", nrow(yocoin_edge_df), "\n")
cat("Num Rows after Filtering: ", nrow(yocoin_edge_df_filtered), "\n")
cat("Num Rows cut: ", (nrow(yocoin_edge_df)-nrow(yocoin_edge_df_filtered)), "\n")

yocoin_edge_df = yocoin_edge_df %>% filter(tokenAmount <= yocoin_decimals * yocoin_supply)

tron_decimals <- 10^6
tron_circulating_supply <- 66682072191

tron_edge_df_filtered = tron_edge_df %>% filter(tokenAmount < tron_decimals*tron_circulating_supply)
cat("Num Rows before Filtering: ", nrow(tron_edge_df), "\n")
cat("Num Rows after Filtering: ", nrow(tron_edge_df_filtered), "\n")
cat("Num Rows cut: ", (nrow(tron_edge_df)-nrow(tron_edge_df_filtered)), "\n")

tron_edge_df = tron_edge_df %>% filter(tokenAmount <= tron_decimals * tron_circulating_supply)

omg_decimals = 10^18 # correct for omisego
omg_supply = 140245398 # correct for omisego

# Filter out rows where the token amount is greater than the total tokenAmount
omg_edge_df_filtered = omg_edge_df %>% filter(tokenAmount < omg_decimals * omg_supply)
cat("Num Rows before Filtering: ", nrow(omg_edge_df), "\n")
cat("Num Rows after Filtering: ", nrow(omg_edge_df_filtered), "\n")
cat("Num Rows cut: ", (nrow(omg_edge_df)-nrow(omg_edge_df_filtered)), "\n")

# Set omg_edge_df to the filtered dataframe
omg_edge_df = omg_edge_df %>% filter(tokenAmount <= omg_decimals * omg_supply)

```

For the sake of basic analysis, we create a value in the dataframe for pairs of buyers and sellers. 

```{r}
yocoin_edge_df$pairFrom <- paste(yocoin_edge_df$fromID, '-', yocoin_edge_df$toID)
yocoin_edge_df$pairTo <- paste(yocoin_edge_df$toID, '-', yocoin_edge_df$fromID)
yocoin_pairFrom_counts <- as.data.frame(table(yocoin_edge_df$pairFrom))
yocoin_pairTo_counts <- as.data.frame(table(yocoin_edge_df$pairTo))
names(yocoin_pairFrom_counts) <- c('Pair', 'Transactions')
names(yocoin_pairTo_counts) <- c('Pair', 'Transactions')
yocoin_pairFrom_counts <- head(yocoin_pairFrom_counts, n = 100)
yocoin_pairTo_counts <- head(yocoin_pairTo_counts, n = 100)

tron_edge_df$pairFrom <- paste(tron_edge_df$fromID, '-', tron_edge_df$toID)
tron_edge_df$pairTo <- paste(tron_edge_df$toID, '-', tron_edge_df$fromID)
tron_pairFrom_counts <- as.data.frame(table(tron_edge_df$pairFrom))
tron_pairTo_counts <- as.data.frame(table(tron_edge_df$pairTo))
names(tron_pairFrom_counts) <- c('Pair', 'Transactions')
names(tron_pairTo_counts) <- c('Pair', 'Transactions')
tron_pairFrom_counts <- head(tron_pairFrom_counts, n = 100)
tron_pairTo_counts <- head(tron_pairTo_counts, n = 100)

omg_edge_df$pairFrom <- paste(omg_edge_df$fromID, '-', omg_edge_df$toID)
omg_edge_df$pairTo <- paste(omg_edge_df$toID, '-', omg_edge_df$fromID)
omg_pairFrom_counts <- as.data.frame(table(yocoin_edge_df$pairFrom))
omg_pairTo_counts <- as.data.frame(table(yocoin_edge_df$pairTo))
names(omg_pairFrom_counts) <- c('Pair', 'Transactions')
names(omg_pairTo_counts) <- c('Pair', 'Transactions')
omg_pairFrom_counts <- head(omg_pairFrom_counts, n = 100)
omg_pairTo_counts <- head(omg_pairTo_counts, n = 100)
```

In this section we plot the Number of Transactions against the pair of buyer and seller. This is just help us understand the distribution of transactions between user pairs. There are two graphs for each coin, respectiv to buyer and seller data.

```{r}
yocoin_plot_transFrom <- ggplot(aes(x=Pair, y=Transactions), data = yocoin_pairFrom_counts) + geom_bar(stat = "identity", color="darkblue") + 
geom_text(aes(label = Transactions))

yocoin_plot_transFrom + ggtitle("YOC Transaction Data") + xlab("Buyer and Seller Pair") + ylab("Number of Transactions")

yocoin_plot_transTo <- ggplot(aes(x=Pair, y=Transactions), data = yocoin_pairTo_counts) + geom_bar(stat = "identity", color="darkblue") + geom_text(aes(label = Transactions))

yocoin_plot_transTo + ggtitle("YOC Transaction Data") + xlab("Buyer and Seller Pair") + ylab("Number of Transactions")

tron_plot_transFrom <- ggplot(aes(x=Pair, y=Transactions), data = tron_pairFrom_counts) + geom_bar(stat = "identity", color="darkred") + geom_text(aes(label=Transactions))

tron_plot_transFrom + ggtitle("TRX Transaction Data") +  xlab("Buyer and Seller Pair") + ylab("Token Amount")

tron_plot_transTo <- ggplot(aes(x=Pair, y=Transactions), data = tron_pairTo_counts) + geom_bar(stat = "identity", color="darkred") + geom_text(aes(label=Transactions))

tron_plot_transTo + ggtitle("TRX Transaction Data") +  xlab("Buyer and Seller Pair") + ylab("Token Amount")

omg_plot_transFrom <- ggplot(aes(x=Pair, y=Transactions), data = omg_pairFrom_counts) + geom_bar(stat = "identity", color="green") + geom_text(aes(label=Transactions))

omg_plot_transFrom + ggtitle("OMG Transaction Data") +  xlab("Buyer and Seller Pair") + ylab("Token Amount")

omg_plot_transTo <- ggplot(aes(x=Pair, y=Transactions), data = omg_pairTo_counts) + geom_bar(stat = "identity", color="green") + geom_text(aes(label=Transactions))

omg_plot_transTo + ggtitle("OMG Transaction Data") +  xlab("Buyer and Seller Pair") + ylab("Token Amount")
```


In this section we take the the same data from above and take into a narrower scope, only 20 of the top transactions. From this we begin calculating the distributions of the transaction data.
```{r}
tron_buys.distribution <- tron_edge_df %>% group_by(toID) %>% summarise(n = n()) %>% ungroup
sells.distribution <- tron_edge_df %>% group_by(fromID) %>% summarise(n = n()) %>% ungroup

cat("Buys Top 20")
print(tron_buys.distribution %>% arrange(-n) %>% head(20))

cat("Sells Top 20")
print(sells.distribution %>% arrange(-n) %>% head(20))

```

```{r}
tron_selldf = tron_sells.distribution %>% arrange(-n) %>% head(20)
tron_selldf$row_id <- as.numeric(row.names(selldf))
tron_sells_quant_bar = ggplot(data=selldf, aes(x=row_id, y=n)) +
  geom_bar(stat="identity", fill="steelblue")+
  geom_text(aes(label=n), vjust=-0.3, size=3.5)+
  theme_minimal()
print(tron_sells_quant_bar)

# Create a bar chart to plot the top 20 sellers by their total tokens sold.
tron_buydf = tron_buys.distribution %>% arrange(-n) %>% head(20)
tron_buydf$row_id <- as.numeric(row.names(buydf))
tron_buys_quant_bar = ggplot(data=buydf, aes(x=row_id, y=n)) +
  geom_bar(stat="identity", fill="steelblue")+
  geom_text(aes(label=n), vjust=-0.3, size=3.5)+
  theme_minimal()
print(tron_buys_quant_bar)
```
Start of Question 2, getting the pairs of buyers and sellers
```{r}
transaction_pair_df <- tron_edge_df
transaction_pair_df$pair = paste(as.character(transaction_pair_df$fromID),"-",as.character(transaction_pair_df$toID))
transactions_by_pair_df = transaction_pair_df %>% group_by(pair) %>% summarise(n = n()) %>% arrange(-n) %>% ungroup
print(transactions_by_pair_df %>% head(20))

total_trade_volume = sum(transactions_by_pair_df$n)

# Optionally Drop out the outlier pair(311608 - 311608), n(30024)
# Comment this line out if you want to leave it in
transactions_by_pair_df = transactions_by_pair_df %>% filter(n < 30000)
cat('FILTERING!\n')


# Filtering and scaling the data in different ways.
pairdf = transactions_by_pair_df %>% head(100)
pairdf$row_id <- as.numeric(row.names(pairdf))
pairdf$n_scaled <- (pairdf$n - min(pairdf$n) + 0.001) / (max(pairdf$n) - min(pairdf$n) + 0.002)
# Reverse it so it goes up and right
# pairdf$n_scaled <- rev(pairdf$n_scaled)
# normalize by total_trade_volume
pairdf$n_norm = pairdf$n / total_trade_volume
```
```{r}
as.data.frame(pairdf)
keeps <- c("n_scaled", "n", "row_id")
clean_data <- as.data.frame(pairdf)[keeps]


fit.lnorm.pairdf = fitdistr(clean_data$n, densfun='lognormal')
fit.exp.pairdf = fitdistr(clean_data$n, densfun='exponential')
fit.geom.pairdf = fitdistr(clean_data$n, densfun='geometric')
fit.weibull.pairdf = fitdistr(clean_data$n, densfun='weibull')
fit.gamma.pairdf = fitdistr(clean_data$n, densfun='gamma')
fit.nbinomial.pairdf = fitdistr(clean_data$n, densfun='negative binomial')

#print(fit.lnorm.pairdf)
# fit.weibull.pairdf = fitdistr(clean_data$n, densfun='weibull', start=list(shape=1, scale=500))
# print(fit.weibull.pairdf$estimate[1])
#print(fit.lnorm.pairdf$estimate[1])
#print(fit.exp.pairdf$estimate[1])
#print(fit.geom.pairdf$estimate[1])
```

```{r}
pair_bar = ggplot(clean_data) +
  # scale_y_continuous(trans = 'log10') +
  # ylim(0, 8) +
  # xlim(0, 1) +
  
  geom_histogram(mapping = aes(x = n), stat = "density", fill="steelblue")   +
  
  
  stat_function( fun = "dlnorm",
                 args = list(meanlog = fit.lnorm.pairdf$estimate[1], sdlog = fit.lnorm.pairdf$estimate[2]),
                 n = 100,
                 size = 1,
                 color = "red") +
  
  
  stat_function(fun = "dexp",
                size = 1,
                args = list(rate = fit.exp.pairdf$estimate[1]),
                color = "green") +
  
 stat_function(fun = "dweibull",
                size = 1,
                args = list(shape = fit.weibull.pairdf$estimate[1],
                scale=fit.weibull.pairdf$estimate[2]),
                color = "orange") +
  
  stat_function(fun = "dgamma",
                size = 1,
                args = list(shape = fit.gamma.pairdf$estimate[1],
                rate=fit.gamma.pairdf$estimate[2]),
                color = "purple") +
  
  
  # The ones below here are somewhat uselss for the full dataset
  stat_function(fun = "dgeom",
                size = 2,
                args = list(prob = fit.geom.pairdf$estimate[1]),
                color = "blue") +
  
  stat_function(fun = "dnbinom",
                size = 1,
                args = list(size = fit.nbinomial.pairdf$estimate[1],
                mu=fit.nbinomial.pairdf$estimate[2]),
                color = "pink") +
  
  
theme_minimal()

# Can do this later...
# list(mean = fit$estimate[1], sd = fit$estimate[2])) 

print(pair_bar)
```