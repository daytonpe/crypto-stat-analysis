---
title: "Statistics Project"
output:
  html_document:
    df_print: paged
---

This is the Analysis of buyers and sellers of the Etheruem coins Tronix (TRX), OmiseGO (OMG) and YoCoin (YOC). We will be looking at transaction data for these markets and trying to make assumptions about future data.

Load the libraries and set the working directory.

```{r}
# install.packages("car")
library(plyr)
library(readr)
library(ggplot2)
library(dplyr)
library(fitdistrplus)
##

setwd('/Users/daytonpe/Dropbox/utd/6316_stat_methods_for_ds_akcora/project/src')
```

This section is loading each tokens historical data into separate data frames. After loading the dataframes, we plot the opening price against the date. A part of the preprocessing was to adjust the date format that was provided.

```{r}
yocoin_price_df = read.table("tokenPrices/yocoin",
                 col.names = c('Date',	'Open',	'High',	'Low',	'Close',	'Volume',	'MarketCap'),
                 skip = 1,
                 header = FALSE)

tron_price_df = read.table("tokenPrices/tron",
                          col.names = c('Date',	'Open',	'High',	'Low',	'Close',	'Volume',	'MarketCap'),
                          skip = 1,
                          header = FALSE)

omg_price_df = read.table("tokenPrices/omisego.txt",
                 col.names = c('Date',	'Open',	'High',	'Low',	'Close',	'Volume',	'MarketCap'),
                 skip = 1,
                 header = FALSE)

cat("Number of duplicates: ", anyDuplicated(yocoin_price_df))

cat("Number of duplicates: ", anyDuplicated(tron_price_df))

cat("Number of duplicates: ", anyDuplicated(omg_price_df))


yocoin_price_df$Date = as.Date(yocoin_price_df$Date,format='%m/%d/%Y')

tron_price_df$Date = as.Date(tron_price_df$Date,format='%m/%d/%Y')

omg_price_df$Date = as.Date(omg_price_df$Date,format='%m/%d/%Y')

yocoin_plot <- ggplot(aes(x=Date, y=Open), data = yocoin_price_df) + geom_point(color="darkblue")

yocoin_plot + ggtitle("YOC Historical Data") +
  xlab("Date") + ylab("Opening Price")

tron_plot <- ggplot(aes(x=Date, y=Open), data = tron_price_df) + geom_point(color="darkred")

tron_plot + ggtitle("TRX Historical Data") +
  xlab("Date") + ylab("Opening Price")

omg_plot <- ggplot(aes(x=Date, y=Open), data = omg_price_df) + geom_point(color="green")

omg_plot + ggtitle("OMG Historical Data") +
  xlab("Date") + ylab("Opening Price")
```

Here we load the recent transaction data for each of coins. We only need to specify the column names for the yo coin file because the file format did not include column names.

```{r}
yocoin_edge_df <- read_delim('edgeFiles/yo.txt', delim = " ", col_names = F)

names(yocoin_edge_df) <- c('fromID', 'toID', 'unixTime', 'tokenAmount')

tron_edge_df <- read_delim('edgeFiles/tron.txt', delim = " ", col_names = F)

omg_edge_df <- read_delim('edgeFiles/yo.txt', delim = " ", col_names = F)



names(tron_edge_df) <- c('fromID', 'toID', 'unixTime', 'tokenAmount')
names(omg_edge_df) <- c('fromID', 'toID', 'unixTime', 'tokenAmount')
```


This step is a small portion of processing where we find any transactions where the quantity exceeds the circulating supply.

From these calculations, only YOC had records that needed to be removed.
```{r}
yocoin_decimals = 10^16
yocoin_supply = 369659255

yocoin_edge_df_filtered = yocoin_edge_df %>% filter(tokenAmount < yocoin_decimals * yocoin_supply)
cat("Num Rows before Filtering: ", nrow(yocoin_edge_df), "\n")
cat("Num Rows after Filtering: ", nrow(yocoin_edge_df_filtered), "\n")
cat("Num Rows cut: ", (nrow(yocoin_edge_df)-nrow(yocoin_edge_df_filtered)), "\n")

yocoin_edge_df = yocoin_edge_df %>% filter(tokenAmount <= yocoin_decimals * yocoin_supply)

tron_decimals <- 10^6
tron_circulating_supply <- 66682072191

tron_edge_df_filtered = tron_edge_df %>% filter(tokenAmount < tron_decimals*tron_circulating_supply)
cat("Num Rows before Filtering: ", nrow(tron_edge_df), "\n")
cat("Num Rows after Filtering: ", nrow(tron_edge_df_filtered), "\n")
cat("Num Rows cut: ", (nrow(tron_edge_df)-nrow(tron_edge_df_filtered)), "\n")

tron_edge_df = tron_edge_df %>% filter(tokenAmount <= tron_decimals * tron_circulating_supply)

omg_decimals = 10^18
omg_supply = 140245398

omg_edge_df_filtered = omg_edge_df %>% filter(tokenAmount < omg_decimals * omg_supply)
cat("Num Rows before Filtering: ", nrow(omg_edge_df), "\n")
cat("Num Rows after Filtering: ", nrow(omg_edge_df_filtered), "\n")
cat("Num Rows cut: ", (nrow(omg_edge_df)-nrow(omg_edge_df_filtered)), "\n")

omg_edge_df = omg_edge_df %>% filter(tokenAmount <= omg_decimals * omg_supply)

```

For the sake of basic analysis, we create a value in the dataframe for pairs of buyers and sellers.

```{r}
yocoin_edge_df$pairFrom <- paste(yocoin_edge_df$fromID, '-', yocoin_edge_df$toID)
yocoin_edge_df$pairTo <- paste(yocoin_edge_df$toID, '-', yocoin_edge_df$fromID)
yocoin_pairFrom_counts <- as.data.frame(table(yocoin_edge_df$pairFrom))
yocoin_pairTo_counts <- as.data.frame(table(yocoin_edge_df$pairTo))
names(yocoin_pairFrom_counts) <- c('Pair', 'Transactions')
names(yocoin_pairTo_counts) <- c('Pair', 'Transactions')
yocoin_pairFrom_counts <- head(yocoin_pairFrom_counts, n = 100)
yocoin_pairTo_counts <- head(yocoin_pairTo_counts, n = 100)

tron_edge_df$pairFrom <- paste(tron_edge_df$fromID, '-', tron_edge_df$toID)
tron_edge_df$pairTo <- paste(tron_edge_df$toID, '-', tron_edge_df$fromID)
tron_pairFrom_counts <- as.data.frame(table(tron_edge_df$pairFrom))
tron_pairTo_counts <- as.data.frame(table(tron_edge_df$pairTo))
names(tron_pairFrom_counts) <- c('Pair', 'Transactions')
names(tron_pairTo_counts) <- c('Pair', 'Transactions')
tron_pairFrom_counts <- head(tron_pairFrom_counts, n = 100)
tron_pairTo_counts <- head(tron_pairTo_counts, n = 100)

omg_edge_df$pairFrom <- paste(omg_edge_df$fromID, '-', omg_edge_df$toID)
omg_edge_df$pairTo <- paste(omg_edge_df$toID, '-', omg_edge_df$fromID)
omg_pairFrom_counts <- as.data.frame(table(yocoin_edge_df$pairFrom))
omg_pairTo_counts <- as.data.frame(table(yocoin_edge_df$pairTo))
names(omg_pairFrom_counts) <- c('Pair', 'Transactions')
names(omg_pairTo_counts) <- c('Pair', 'Transactions')
omg_pairFrom_counts <- head(omg_pairFrom_counts, n = 100)
omg_pairTo_counts <- head(omg_pairTo_counts, n = 100)
```

In this section we plot the Number of Transactions against the pair of buyer and seller. This is just help us understand the distribution of transactions between user pairs. There are two graphs for each coin, respectiv to buyer and seller data.

```{r}
yocoin_plot_transFrom <- ggplot(aes(x=Pair, y=Transactions), data = yocoin_pairFrom_counts) + geom_bar(stat = "identity", color="darkblue") +
geom_text(aes(label = Transactions))

yocoin_plot_transFrom + ggtitle("YOC Transaction Data") + xlab("Buyer and Seller Pair") + ylab("Number of Transactions")

yocoin_plot_transTo <- ggplot(aes(x=Pair, y=Transactions), data = yocoin_pairTo_counts) + geom_bar(stat = "identity", color="darkblue") + geom_text(aes(label = Transactions))

yocoin_plot_transTo + ggtitle("YOC Transaction Data") + xlab("Buyer and Seller Pair") + ylab("Number of Transactions")

tron_plot_transFrom <- ggplot(aes(x=Pair, y=Transactions), data = tron_pairFrom_counts) + geom_bar(stat = "identity", color="darkred") + geom_text(aes(label=Transactions))

tron_plot_transFrom + ggtitle("TRX Transaction Data") +  xlab("Buyer and Seller Pair") + ylab("Token Amount")

tron_plot_transTo <- ggplot(aes(x=Pair, y=Transactions), data = tron_pairTo_counts) + geom_bar(stat = "identity", color="darkred") + geom_text(aes(label=Transactions))

tron_plot_transTo + ggtitle("TRX Transaction Data") +  xlab("Buyer and Seller Pair") + ylab("Token Amount")

omg_plot_transFrom <- ggplot(aes(x=Pair, y=Transactions), data = omg_pairFrom_counts) + geom_bar(stat = "identity", color="green") + geom_text(aes(label=Transactions))

omg_plot_transFrom + ggtitle("OMG Transaction Data") +  xlab("Buyer and Seller Pair") + ylab("Token Amount")

omg_plot_transTo <- ggplot(aes(x=Pair, y=Transactions), data = omg_pairTo_counts) + geom_bar(stat = "identity", color="green") + geom_text(aes(label=Transactions))

omg_plot_transTo + ggtitle("OMG Transaction Data") +  xlab("Buyer and Seller Pair") + ylab("Token Amount")
```


In this section we take the the same data from above and take into a narrower scope, only 20 of the top transaction amounts. From this we begin calculating the distributions of the transaction data.
```{r}
yocoin_buys.distribution <- yocoin_edge_df %>% group_by(toID) %>% summarise(n = n()) %>% ungroup
yocoin_sells.distribution <- yocoin_edge_df %>% group_by(fromID) %>% summarise(n = n()) %>% ungroup

tron_buys.distribution <- tron_edge_df %>% group_by(toID) %>% summarise(n = n()) %>% ungroup
tron_sells.distribution <- tron_edge_df %>% group_by(fromID) %>% summarise(n = n()) %>% ungroup

omg_buys.distribution <- omg_edge_df %>% group_by(toID) %>% summarise(n = n()) %>% ungroup
omg_sells.distribution <- omg_edge_df %>% group_by(fromID) %>% summarise(n = n()) %>% ungroup

print("Buys Top 20")
print(yocoin_buys.distribution %>% arrange(-n) %>% head(20))
print(tron_buys.distribution %>% arrange(-n) %>% head(20))
print(omg_buys.distribution %>% arrange(-n) %>% head(20))

print("Sells Top 20")
print(yocoin_sells.distribution %>% arrange(-n) %>% head(20))
print(tron_sells.distribution %>% arrange(-n) %>% head(20))
print(omg_sells.distribution %>% arrange(-n) %>% head(20))

```
This section takes the seller and buyer distribution data, orders it by decreasing amount and finalizes the amount to 20.

Once theses calculations are completed, we plot these data frames into respective bar charts and provide numeric values at the top of the bar.

This data is far more useful in showing the transaction data.
```{r}
yocoin_sell_df = yocoin_sells.distribution %>% arrange(-n) %>% head(20)
yocoin_sell_df$row_id <- as.numeric(row.names(yocoin_sell_df))
yocoin_sells_quant_bar = ggplot(data=yocoin_sell_df, aes(x=row_id, y=n)) +
  geom_bar(stat="identity", fill="steelblue")+
  geom_text(aes(label=n), vjust=-0.3, size=3.5)+
  theme_minimal()
print(yocoin_sells_quant_bar)

yocoin_buy_df = yocoin_buys.distribution %>% arrange(-n) %>% head(20)
yocoin_buy_df$row_id <- as.numeric(row.names(yocoin_buy_df))
yocoin_buys_quant_bar = ggplot(data=yocoin_buy_df, aes(x=row_id, y=n)) +
  geom_bar(stat="identity", fill="steelblue")+
  geom_text(aes(label=n), vjust=-0.3, size=3.5)+
  theme_minimal()
print(yocoin_buys_quant_bar)


tron_sell_df = yocoin_sells.distribution %>% arrange(-n) %>% head(20)
tron_sell_df$row_id <- as.numeric(row.names(tron_sell_df))
tron_sells_quant_bar = ggplot(data=tron_sell_df, aes(x=row_id, y=n)) +
  geom_bar(stat="identity", fill="steelblue")+
  geom_text(aes(label=n), vjust=-0.3, size=3.5)+
  theme_minimal()
print(tron_sells_quant_bar)

tron_buy_df = yocoin_buys.distribution %>% arrange(-n) %>% head(20)
tron_buy_df$row_id <- as.numeric(row.names(tron_buy_df))
tron_buys_quant_bar = ggplot(data=tron_buy_df, aes(x=row_id, y=n)) +
  geom_bar(stat="identity", fill="steelblue")+
  geom_text(aes(label=n), vjust=-0.3, size=3.5)+
  theme_minimal()
print(tron_buys_quant_bar)

omg_sell_df = omg_sells.distribution %>% arrange(-n) %>% head(20)
omg_sell_df$row_id <- as.numeric(row.names(omg_sell_df))
omg_sells_quant_bar = ggplot(data=omg_sell_df, aes(x=row_id, y=n)) +
  geom_bar(stat="identity", fill="steelblue")+
  geom_text(aes(label=n), vjust=-0.3, size=3.5)+
  theme_minimal()
print(omg_sells_quant_bar)

omg_buy_df = omg_buys.distribution %>% arrange(-n) %>% head(20)
omg_buy_df$row_id <- as.numeric(row.names(omg_buy_df))
omg_buys_quant_bar = ggplot(data=omg_buy_df, aes(x=row_id, y=n)) +
  geom_bar(stat="identity", fill="steelblue")+
  geom_text(aes(label=n), vjust=-0.3, size=3.5)+
  theme_minimal()
print(omg_buys_quant_bar)
```

This section is dedicated to making getting proper buying distributions (ordered and truncated to the top 20). We calculate the total volume of the transactions. After that we filter the data, apply some scaling attributes and normalize the data.

```{r}
yocoin_by_pair_df = yocoin_edge_df %>% group_by(pairFrom) %>% summarise(n = n()) %>% arrange(-n) %>% ungroup
print(yocoin_by_pair_df %>% head(20))

tron_by_pair_df = tron_edge_df %>% group_by(pairFrom) %>% summarise(n = n()) %>% arrange(-n) %>% ungroup
print(yocoin_by_pair_df %>% head(20))

omg_by_pair_df = omg_edge_df %>% group_by(pairFrom) %>% summarise(n = n()) %>% arrange(-n) %>% ungroup
print(yocoin_by_pair_df %>% head(20))

yocoin_total_trade_volume = sum(yocoin_by_pair_df$n)
tron_total_trade_volume = sum(tron_by_pair_df$n)
omg_total_trade_volume = sum(omg_by_pair_df$n)

# Optionally Drop out the outlier pair(311608 - 311608), n(30024)
# Comment this line out if you want to leave it in
#yocoin_by_pair_df = yocoin_by_pair_df %>% filter(n < 30000)
#cat('FILTERING!\n')


# Filtering and scaling the data in different ways.
yocoin_pair_df = yocoin_by_pair_df %>% head(100)
yocoin_pair_df$row_id <- as.numeric(row.names(yocoin_pair_df))
yocoin_pair_df$n_scaled <- (yocoin_pair_df$n - min(yocoin_pair_df$n) + 0.001) / (max(yocoin_pair_df$n) - min(yocoin_pair_df$n) + 0.002)

tron_pair_df = tron_by_pair_df %>% head(100)
tron_pair_df$row_id <- as.numeric(row.names(tron_pair_df))
tron_pair_df$n_scaled <- (tron_pair_df$n - min(tron_pair_df$n) + 0.001) / (max(tron_pair_df$n) - min(tron_pair_df$n) + 0.002)

omg_pair_df = yocoin_by_pair_df %>% head(100)
omg_pair_df$row_id <- as.numeric(row.names(omg_pair_df))
omg_pair_df$n_scaled <- (omg_pair_df$n - min(omg_pair_df$n) + 0.001) / (max(omg_pair_df$n) - min(omg_pair_df$n) + 0.002)
# Reverse it so it goes up and right
# pairdf$n_scaled <- rev(pairdf$n_scaled)
# normalize by total_trade_volume
yocoin_pair_df$n_norm = yocoin_pair_df$n / yocoin_total_trade_volume
tron_pair_df$n_norm = tron_pair_df$n / tron_total_trade_volume
omg_pair_df$n_norm = omg_pair_df$n / omg_total_trade_volume
```


## Fit Distributions
From here we take the data, and apply some different distributions.
- Log Normal
- Exponential
- Geometric
- Weibull
- Gamma
- Negative Binomial

```{r}
as.data.frame(yocoin_pair_df)
as.data.frame(tron_pair_df)
as.data.frame(omg_pair_df)

keeps <- c("n_scaled", "n", "row_id")

yocoin_clean_data <- as.data.frame(yocoin_pair_df)[keeps]
tron_clean_data <- as.data.frame(tron_pair_df)[keeps]
omg_clean_data <- as.data.frame(omg_pair_df)[keeps]


fit.lnorm.yocoin_pair_df = fitdistr(yocoin_clean_data$n, densfun='lognormal')
fit.exp.yocoin_pair_df = fitdistr(yocoin_clean_data$n, densfun='exponential')
# fit.geom.yocoin_pair_df = fitdistr(yocoin_clean_data$n, densfun='geometric')
# fit.weibull.yocoin_pair_df = fitdistr(yocoin_clean_data$n, densfun='weibull')
fit.gamma.yocoin_pair_df = fitdistr(yocoin_clean_data$n, densfun='gamma')
fit.nbinomial.yocoin_pair_df = fitdistr(yocoin_clean_data$n, densfun='negative binomial')

fit.lnorm.tron_pair_df = fitdistr(tron_clean_data$n, densfun='lognormal')
fit.exp.tron_pair_df = fitdistr(tron_clean_data$n, densfun='exponential')
# fit.geom.tron_pair_df = fitdistr(tron_clean_data$n, densfun='geometric')
fit.weibull.tron_pair_df = fitdistr(tron_clean_data$n, densfun='weibull')
fit.gamma.tron_pair_df = fitdistr(tron_clean_data$n, densfun='gamma')
fit.nbinomial.tron_pair_df = fitdistr(tron_clean_data$n, densfun='negative binomial')

fit.lnorm.omg_pair_df = fitdistr(omg_clean_data$n, densfun='lognormal')
fit.exp.omg_pair_df = fitdistr(omg_clean_data$n, densfun='exponential')
# fit.geom.omg_pair_df = fitdistr(omg_clean_data$n, densfun='geometric')
# fit.weibull.omg_pair_df = fitdistr(omg_clean_data$n, densfun='weibull')
fit.gamma.omg_pair_df = fitdistr(omg_clean_data$n, densfun='gamma')
fit.nbinomial.omg_pair_df = fitdistr(omg_clean_data$n, densfun='negative binomial')

#print(fit.lnorm.pairdf)
# fit.weibull.pairdf = fitdistr(clean_data$n, densfun='weibull', start=list(shape=1, scale=500))
# print(fit.weibull.pairdf$estimate[1])
#print(fit.lnorm.pairdf$estimate[1])
#print(fit.exp.pairdf$estimate[1])
#print(fit.geom.pairdf$estimate[1])
```


This section is just to set up and show the plot for each of the coins and their processed data.

```{r}
yocoin_pair_bar = ggplot(yocoin_clean_data) + geom_histogram(mapping = aes(x = n), stat = "density", fill="steelblue") +
  stat_function( fun = "dlnorm",
                 args = list(meanlog = fit.lnorm.yocoin_pair_df$estimate[1], sdlog = fit.lnorm.yocoin_pair_df$estimate[2]),
                 n = 100,
                 size = 1,
                 color = "red") +
  stat_function(fun = "dexp",
                size = 1,
                args = list(rate = fit.exp.yocoin_pair_df$estimate[1]),
                color = "green") +
  stat_function(fun = "dweibull",
                size = 1,
                args = list(shape = fit.weibull.yocoin_pair_df$estimate[1],
                scale=fit.weibull.yocoin_pair_df$estimate[2]),
                color = "orange") +
  stat_function(fun = "dgamma",
                size = 1,
                args = list(shape = fit.gamma.yocoin_pair_df$estimate[1],
                rate=fit.gamma.yocoin_pair_df$estimate[2]),
                color = "purple") +
  #The ones below here are somewhat uselss for the full dataset
  # stat_function(fun = "dgeom",
  #               size = 2,
  #               args = list(prob = fit.geom.yocoin_pair_df$estimate[1]),
  #               color = "blue") +
  stat_function(fun = "dnbinom",
                size = 1,
                args = list(size = fit.nbinomial.yocoin_pair_df$estimate[1],
                mu=fit.nbinomial.yocoin_pair_df$estimate[2]),
                color = "pink") +
  theme_minimal()

tron_pair_bar = ggplot(tron_clean_data) + geom_histogram(mapping = aes(x = n), stat = "density", fill="steelblue") +
  stat_function( fun = "dlnorm",
                 args = list(meanlog = fit.lnorm.tron_pair_df$estimate[1], sdlog = fit.lnorm.tron_pair_df$estimate[2]),
                 n = 100,
                 size = 1,
                 color = "red") +
  stat_function(fun = "dexp",
                size = 1,
                args = list(rate = fit.exp.tron_pair_df$estimate[1]),
                color = "green") +
  stat_function(fun = "dweibull",
                size = 1,
                args = list(shape = fit.weibull.tron_pair_df$estimate[1],
                scale=fit.weibull.tron_pair_df$estimate[2]),
                color = "orange") +
  stat_function(fun = "dgamma",
                size = 1,
                args = list(shape = fit.gamma.tron_pair_df$estimate[1],
                rate=fit.gamma.tron_pair_df$estimate[2]),
                color = "purple") +
  #The ones below here are somewhat uselss for the full dataset
  # stat_function(fun = "dgeom",
  #               size = 2,
  #               args = list(prob = fit.geom.tron_pair_df$estimate[1]),
  #               color = "blue") +
  stat_function(fun = "dnbinom",
                size = 1,
                args = list(size = fit.nbinomial.tron_pair_df$estimate[1],
                mu=fit.nbinomial.tron_pair_df$estimate[2]),
                color = "pink") +
  theme_minimal()

omg_pair_bar = ggplot(omg_clean_data) + geom_histogram(mapping = aes(x = n), stat = "density", fill="steelblue") +
  stat_function( fun = "dlnorm",
                 args = list(meanlog = fit.lnorm.omg_pair_df$estimate[1], sdlog = fit.lnorm.omg_pair_df$estimate[2]),
                 n = 100,
                 size = 1,
                 color = "red") +
  stat_function(fun = "dexp",
                size = 1,
                args = list(rate = fit.exp.omg_pair_df$estimate[1]),
                color = "green") +
  stat_function(fun = "dweibull",
                size = 1,
                args = list(shape = fit.weibull.omg_pair_df$estimate[1],
                scale=fit.weibull.omg_pair_df$estimate[2]),
                color = "orange") +
  stat_function(fun = "dgamma",
                size = 1,
                args = list(shape = fit.gamma.omg_pair_df$estimate[1],
                rate=fit.gamma.omg_pair_df$estimate[2]),
                color = "purple") +
  #The ones below here are somewhat uselss for the full dataset
  # stat_function(fun = "dgeom",
  #               size = 2,
  #               args = list(prob = fit.geom.omg_pair_df$estimate[1]),
  #               color = "blue") +
  stat_function(fun = "dnbinom",
                size = 1,
                args = list(size = fit.nbinomial.omg_pair_df$estimate[1],
                mu=fit.nbinomial.omg_pair_df$estimate[2]),
                color = "pink") +
  theme_minimal()

# Can do this later...
# list(mean = fit$estimate[1], sd = fit$estimate[2]))

print(yocoin_pair_bar)
print(tron_pair_bar)
print(omg_pair_bar)
```
